---
title: "Comment ajouter votre statut de d√©ploiement de Render dans votre repo Github avec Python"
publishedAt: "2023-11-20"
summary: "Un aper√ßu rapide de la configuration du projet et de la stack technologique que j'ai utilis√©."
tags:
  - Python
  - CI/CD
  - Linter
  - Formater
  - Sonar Cloud
shortTitle: Render API
---

## Pourquoi ai-je d√©marr√© ce projet?

En entamant le d√©veloppement de mon application Render Deployment au cours du d√©veloppement d'une autre application bas√©e sur une API REST en Python, j'ai √©t√© motiv√© par la n√©cessit√© d'avoir un suivi transparent du statut de d√©ploiement directement dans le r√©f√©rentiel GitHub.

J'avais pr√©c√©demment utilis√© Vercel, qui offrait cette fonctionnalit√© automatiquement pour mon portfolio, et j'ai trouv√© cela extr√™mement utile. 

Cependant, lorsque j'ai migr√© vers Render, j'ai rapidement r√©alis√© qu'il n'existait pas d'application officielle GitHub pour g√©rer la CI/CD, ce qui m'a pouss√© √† d√©velopper ma propre solution. Cette exp√©rience m'a permis de mieux comprendre les besoins sp√©cifiques de mon workflow de d√©veloppement et de cr√©er une application qui r√©pondait parfaitement √† ces exigences.

> Innover, c'est dire non √† mille choses. Steve Jobs (1955-2011)

## Sources de donn√©es

Les sources de donn√©es proviennent des commits √©mits sur la branche main de n'importe quel projet qui utilise une application Github qui renvoie un webhook √† l'API qui elle-m√™me est li√©e √† un d√©ploiement sur Render.

<Image
  width={600}
  height={400}
  src="/blog/render-deployment/github-actions.svg"
/>

## Stack technologique

Ce projet utilise FastAPI en Python 3.0. Il fait le lien entre les webhooks de Render et les webhooks de l'application Github afin de r√©cup√©rer et transmettre le statut de d√©ploiement d'une application render dans la branch github.

Le projet utilise Black et Flake8 pour le formatage du code. SonarCloud lui est utilis√© pour √©viter des vuln√©rabilit√©s et scanner l'optimisation du code. 

<Image
  width={600}
  height={400}
  src="/blog/render-deployment/stack.svg"
/>

## Comment √ßa fonctionne

Le code qui va suivre explique bri√®vement comment fonctionne le projet ainsi que les m√©thodes qui le compose.

Si vous souhaitez plus d'informations concernant le projet je vous laisse aller sur la documentation du projet qui ce trouve sur mon Github.

<Alert type="warning">
  Le code est volontairement incomplet pour facilit√© l'explication.
</Alert>

### 1. R√©cup√©ration de l'event de l'application Github üì≤

Comme expliqu√© dans la [documentation](https://github.com/Fyleek/render-api?tab=readme-ov-file#installation-and-creation-of-the-github-app), vous devez cr√©er une application Github qui peut acc√©der √† votre workflow, d√©ploiement, metadata, ...

Ensuite elle doit transmettre un [event](https://docs.github.com/en/webhooks/webhook-events-and-payloads#pull_request) √† votre webhook

```python showLineNumbers {1}
def manage_deployment_status(data: Dict):
    pr = data["pull_request"]
    repo_data = data["repository"]
    state, merged = pr["state"], pr["merged"]
    user_repo, repo_url = repo_data["full_name"], repo_data["html_url"]
    owner, repo = repo_data["owner"]["login"], repo_data["name"]

    if not (merged and state == "closed"):
        return

    service_id = get_render_service_id(repo_url)
    if not service_id:
        logger.error("Render service ID is null")
        return

    deployment_status = get_render_deployment_status(service_id)
    if not deployment_status:
        return

    process_deployment_status(user_repo, repo, owner, deployment_status, service_id)
```

### 2. R√©cup√©ration des informations üßÆ

Si la `pull_request` est `merged`, nous allons maintenant aller r√©cup√©rer le statut de d√©ploiement sur l'API de Render afin de voir si elle est `success` ou `failure` 

```py showLineNumbers {5}
def update_github_deployment_status(owner, repo, status, deployment_id, user_repo, github_deployment_id, service_id):
    create_github_deployment_status(owner, repo, status, deployment_id, user_repo, github_deployment_id)
    new_status = ""
    while new_status not in ["failure", "success"]:
        new_render_deployment_status = get_render_deployment_status(service_id)
        new_status = get_github_status(new_render_deployment_status["status"])
        time.sleep(10)  # You can remove it (but it's better to not spam the render API [400 GET request/minutes])
    create_github_deployment_status(owner, repo, new_status, deployment_id, user_repo, github_deployment_id)
```

### 3. Assignation des statuts üì®

Je fais un mapping des statuts de Render vers les statuts de Github pour ensuite retourner √† Github le statut final de d√©ploiement

```py
def get_github_status(render_status: str) -> str:
    #  Link between render and github status
    state_mapping = {
        "build_in_progress": "in_progress",
        "created": "in_progress",
        "update_in_progress": "in_progress",
        "pre_deploy_in_progress": "in_progress",
        "live": "success",
        "build_failed": "failure",
        "update_failed": "failure",
        "pre_deploy_failed": "failure",
        "canceled": "cancel",
        "deactivated": "inactive",
    }

    return state_mapping.get(render_status, "error")
```

### 4. Retour du statut de d√©ploiement √† Github üìä

Une fois que nous avons le statut final, nous pouvons renvoyer le statut √† Github

```python showLineNumbers {10-17}
def create_github_deployment_status(
    owner: str,
    repo: str,
    status: str,
    render_deployment_id: str,
    user_repo: str,
    github_deployment_id: str,
):
    url = f"{GITHUB_ROOT}/repos/{user_repo}/deployments/{github_deployment_id}/statuses"
    data = {
        "owner": owner,
        "repo": repo,
        "state": status,
        "deployment_id": render_deployment_id,
        "environment": "Production",
        "description": "Deployment status from Render",
    }
    response = session.post(url, headers=get_headers("github"), json=data)
    logger.info(f"POST: {url} executed with status_code: {response.status_code}")
```

<Alert type="info">
  Visiter la <a href="https://github.com/Fyleek/render-api" style={{"color": "blue"}}>documentation</a> pour une meilleur compr√©hension.
</Alert>

## Finalit√©

Alors ai-je atteint mon objectif initial ? Oui, le manque d'une application CI/CD de Render pour les d√©ploiements est r√©solu avec mon application.

Ce projet r√©pond √† une toute petite partie des besoins et des possibilit√©s entre Render et la CI/CD de Github, en revanche c'est un premier pas pour moi et pour d'autres utilisateurs qui souhaiterais ajouter leurs pierres √† l'√©difice.

Si vous √™tes un d√©veloppeur et que vous souhaitez contribuer au projet et ajouter de nouvelles fonctionnalit√©s √† l'API, vous pouvez consulter la documentation sur le [repo](https://github.com/Fyleek/render-api)
